name: Roslyn Analyzer PR Check

on:
  pull_request:

jobs:
  analyze-cs-files:
    name: Run Roslyn Analyzer on Changed C# Files
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x' # Adjust if using .NET 8 or lower

      - name: üîç Get Changed C# Files
        id: changed_cs
        run: |
          git fetch origin
          CHANGED_CS=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} -- '*.cs')
          echo "CHANGED_CS=$CHANGED_CS" >> $GITHUB_ENV
          echo "$CHANGED_CS" > changed_files.txt

      - name: ‚úÖ Skip analysis if no C# files were modified
        if: env.CHANGED_CS == ''
        run: |
          echo "‚úÖ No .cs files changed in PR. Skipping Roslyn analysis."
          exit 0

      - name: üîß Restore Solution or Projects
        run: |
          if [ -f "MyAnalyzerEnabledApi.sln" ]; then
            dotnet restore MyAnalyzerEnabledApi.sln
          else
            for proj in $(find . -name '*.csproj'); do
              dotnet restore "$proj"
            done
          fi

      - name: üö¶ Analyze Changed C# Files Only
        run: |
          EXIT_CODE=0
          while IFS= read -r file; do
            echo "üîç Analyzing file: $file"
            dotnet build "$file" -warnaserror || EXIT_CODE=1
          done < changed_files.txt
          exit $EXIT_CODE
